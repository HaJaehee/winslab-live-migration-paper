#!/bin/sh -e
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.

# in port 1
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.41.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.20.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.40.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.21.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.50.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.30.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.64.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.48.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.32.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
#usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=720,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.10.2 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=720,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.16.0.0/12 actions=mod_dl_src:20:00:00:00:00:02,mod_dl_dst:10:00:00:00:00:01,dec_ttl,output:2"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,arp,in_port=1,arp_tpa=10.0.0.0/8 actions=move:NXM_OF_ETH_SRC[]->NXM_OF_ETH_DST[],mod_dl_src:20:00:00:00:00:01,load:0x2->NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]->NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]->NXM_NX_REG0[],move:NXM_OF_ARP_TPA[]->NXM_OF_ARP_SPA[],load:0x200000000001->NXM_NX_ARP_SHA[],move:NXM_NX_REG0[]->NXM_OF_ARP_TPA[],IN_PORT"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.0.10.1 actions=output:LOCAL"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.16.0.1 actions=mod_nw_dst:10.0.10.1,resubmit(,0)"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=100,ip,in_port=1,nw_dst=10.0.0.0/8 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,output:1"
## br0-wlan0
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=1,nw_dst=10.32.1.2 actions=mod_dl_src:20:00:00:00:00:10,mod_dl_dst:50:3e:aa:ae:05:51,output:3"
## 
#

# in port 3
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=200,ip,in_port=LOCAL,nw_dst=10.16.0.0/12 actions=mod_dl_src:20:00:00:00:00:02,mod_dl_dst:10:00:00:00:00:01,output:2"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.41.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.20.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.40.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.21.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.50.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.30.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.64.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.48.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.32.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=720,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.10.2 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=720,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.16.0.0/12 actions=mod_dl_src:20:00:00:00:00:02,mod_dl_dst:10:00:00:00:00:01,dec_ttl,output:2"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,arp,in_port=3,arp_tpa=10.0.0.0/8 actions=move:NXM_OF_ETH_SRC[]->NXM_OF_ETH_DST[],mod_dl_src:20:00:00:00:00:10,load:0x2->NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]->NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]->NXM_NX_REG0[],move:NXM_OF_ARP_TPA[]->NXM_OF_ARP_SPA[],load:0x200000000010->NXM_NX_ARP_SHA[],move:NXM_NX_REG0[]->NXM_OF_ARP_TPA[],IN_PORT"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=100,ip,in_port=3,nw_dst=10.0.0.0/8 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.16.0.1 actions=mod_nw_dst:10.0.10.1,resubmit(,0)"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.0.10.1 actions=mod_dl_dst:20:00:00:00:00:01,output:LOCAL"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=3,dl_dst=20:00:00:00:00:10,nw_dst=10.16.1.1 actions=mod_nw_dst:10.0.10.1,resubmit(,0)"
## br0-wlan0
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=3,nw_dst=10.32.1.2 actions=mod_dl_src:20:00:00:00:00:10,mod_dl_dst:50:3e:aa:ae:05:51,output:3"
##
#

# in port local
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=200,ip,in_port=LOCAL,nw_dst=10.16.0.0/12 actions=mod_dl_src:20:00:00:00:00:02,mod_dl_dst:10:00:00:00:00:01,output:2"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.0.41.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.0.20.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.0.40.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.0.21.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.0.50.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=640,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.0.30.0/24 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.64.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.48.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=520,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.32.0.0/12 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=720,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:10,nw_dst=10.0.10.2 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,dec_ttl,output:1"
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=720,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.16.0.0/12 actions=mod_dl_src:20:00:00:00:00:02,mod_dl_dst:10:00:00:00:00:01,dec_ttl,output:2"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,arp,in_port=LOCAL,arp_tpa=10.0.0.0/8 actions=move:NXM_OF_ETH_SRC[]->NXM_OF_ETH_DST[],mod_dl_src:20:00:00:00:00:01,load:0x2->NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]->NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]->NXM_NX_REG0[],move:NXM_OF_ARP_TPA[]->NXM_OF_ARP_SPA[],load:0x200000000001->NXM_NX_ARP_SHA[],move:NXM_NX_REG0[]->NXM_OF_ARP_TPA[],IN_PORT"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=100,ip,in_port=LOCAL,nw_dst=10.0.0.0/8 actions=mod_dl_src:20:00:00:00:00:01,mod_dl_dst:20:00:00:00:03:03,output:1"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:01,nw_dst=10.16.0.1 actions=mod_nw_dst:10.0.10.1,resubmit(,0)"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:01,nw_dst=10.0.10.1 actions=output:LOCAL"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=LOCAL,dl_dst=20:00:00:00:00:01,nw_dst=10.16.1.1 actions=mod_nw_dst:10.0.10.1,resubmit(,0)"
## br0-wlan0
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=LOCAL,nw_dst=10.32.1.2 actions=mod_dl_src:20:00:00:00:00:10,mod_dl_dst:50:3e:aa:ae:05:51,output:3"
##
#


#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=LOCAL,nw_dst=10.16.0.1 actions=drop"
/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=10 actions=drop"
#ooni-Start
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=720,ip,in_port=1,dl_dst=20:00:00:00:00:01,nw_dst=10.16.0.0/12 actions=mod_dl_src:20:00:00:00:00:02,mod_dl_dst:00:1e:e5:e5:72:05,dec_ttl,output:2"
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=200,ip,in_port=LOCAL,nw_dst=10.16.0.0/12 actions=mod_dl_src:20:00:00:00:00:02,mod_dl_dst:00:1e:e5:e5:72:05,output:2"
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=2,nw_src=0.0.0.0,nw_dst=255.255.255.255 actions=mod_dl_dst:20:00:00:00:00:01,resubmit(,0)"
#ooni-End
#jaehyun-Start
#/usr/local/bin/ovs-ofctl add-flow s1 "table=0, priority=65535,ip,in_port=2,dl_dst=20:00:00:00:02:02 actions=mod_dl_dst:20:00:00:00:00:02,resubmit(,0)"

#jaehyun-End


#/sbin/ifconfig wlan0 hw ether 20:00:00:00:00:10
/sbin/ifconfig s1 hw ether 20:00:00:00:00:01
#/sbin/ifconfig wlan0 10.16.1.1 netmask 255.0.0.0

/sbin/ethtool --offload s1 rx off tx off 
/sbin/ethtool --offload p1p1 rx off tx off 
/sbin/ethtool --offload p1p2 rx off tx off 
#ooni-Start
#/etc/init.d/isc-dhcp-server stop
#ooni-End
#/etc/init.d/isc-dhcp-server start
#/usr/sbin/hostapd /etc/hostapd/hostapd.conf &
exit 0
